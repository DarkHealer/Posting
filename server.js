
//Ce server utilise le contract Posting.sol


var express = require('express');
var app = express();

var fs = require('fs');
var cOrdre = fs.readFileSync("Referentiel/Ordre.json");
var cBaseClient = fs.readFileSync("Referentiel/BaseClient.json");
var cBaseBareme = fs.readFileSync("Referentiel/BaseBareme.json");
var cBaseCalend = fs.readFileSync("Referentiel/BaseCalend.json");
var cBaseDepot = fs.readFileSync("Referentiel/BaseDepot.json");
var cBaseTiers = fs.readFileSync("Referentiel/BaseTiers.json");
var cBaseValeur = fs.readFileSync("Referentiel/BaseValeur.json");

var ordre = JSON.parse(cOrdre);
var BaseClient = JSON.parse(cBaseClient);
var BaseBareme = JSON.parse(cBaseBareme);
var BaseCalend = JSON.parse(cBaseCalend);
var BaseDepot = JSON.parse(cBaseDepot);
var BaseTiers = JSON.parse(cBaseTiers);
var BaseValeur = JSON.parse(cBaseValeur);

var bodyParser = require('body-parser');
var multer = require('multer');
var upload = multer();
app.use(bodyParser.json()); 
app.use(bodyParser.urlencoded({extended: false})); 


var Web3 = require('web3');
var web3 = new Web3();
web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

var addressContract;
var contractInstance;
var contract;

//Deploy the smart contract
app.get('/deploy', function(req, res) {
    //init constructor input
   var vRef = ordre.reference;
    var vQuantite = ordre.quantite;
    var vMontant = ordre.montant;
    //Contract Interface
   contract = web3.eth.contract([{"constant":false,"inputs":[{"name":"coursCot","type":"uint256"},{"name":"plCot","type":"uint256"}],"name":"calcul","outputs":[{"name":"result","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"getState","outputs":[{"name":"truc","type":"uint8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_aMontant","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"avisOperer","outputs":[{"name":"message","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_numOffre","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_aBareme","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"result","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_aValeur","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"val","type":"uint256"}],"name":"getOffre","outputs":[{"name":"Valeur","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_aQuantite","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_state","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"state","type":"uint8"},{"name":"message","type":"string"}],"name":"setState","outputs":[{"name":"mess","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"vQuantite","type":"string"},{"name":"vMontant","type":"string"}],"name":"addOffre","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_aRef","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"inputs":[{"name":"vRef","type":"string"},{"name":"vQuantite","type":"string"},{"name":"vMontant","type":"string"}],"payable":false,"type":"constructor"}]);

    //Instaciate the contract in the blockchain
    contractInstance = contract.new(
        vRef,
        vQuantite,
        vMontant, {
            from: web3.eth.accounts[0],
            data: '606060405234156200000d57fe5b60405162001d1038038062001d10833981016040528080518201919060200180518201919060200180518201919050505b620000c783604060405190810160405280600481526020017f2030314200000000000000000000000000000000000000000000000000000000815250602060405190810160405280600081525060206040519081016040528060008152506020604051908101604052806000815250620001406401000000000262001153176401000000009004565b60009080519060200190620000de929190620005a1565b508160019080519060200190620000f7929190620005a1565b50806002908051906020019062000110929190620005a1565b506000600860006101000a81548160ff021916908360028111156200013157fe5b02179055505b50505062000678565b6200014a62000628565b620001546200063c565b6200015e6200063c565b620001686200063c565b620001726200063c565b6200017c6200063c565b6200018662000628565b620001906200063c565b600060008e98508d97508c96508b95508a94508451865188518a518c5101010101604051805910620001bf5750595b908082528060200260200182016040525b50935083925060009150600090505b885181101562000297578881815181101515620001f857fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015156200025857fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b8080600101915050620001df565b600090505b875181101562000354578781815181101515620002b557fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015156200031557fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b80806001019150506200029c565b600090505b8651811015620004115786818151811015156200037257fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028383806001019450815181101515620003d257fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505062000359565b600090505b8551811015620004ce5785818151811015156200042f57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015156200048f57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505062000416565b600090505b84518110156200058b578481815181101515620004ec57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015156200054c57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b8080600101915050620004d3565b8299505b50505050505050505095945050505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620005e457805160ff191683800117855562000615565b8280016001018555821562000615579182015b8281111562000614578251825591602001919060010190620005f7565b5b50905062000624919062000650565b5090565b602060405190810160405280600081525090565b602060405190810160405280600081525090565b6200067591905b808211156200067157600081600090555060010162000657565b5090565b90565b61168880620006886000396000f300606060405236156100ce576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806303cf420e146100d05780631865c57d1461010d5780631d8341bb14610141578063292f2dc1146101da578063367197881461027357806344b095b61461029957806365372147146103325780637180379b1461035857806380840dfc146103f15780639059122614610498578063a1cb31b714610531578063b283ae1f14610565578063b496c59414610652578063b6924e54146106ef575bfe5b34156100d857fe5b6100f76004808035906020019091908035906020019091905050610788565b6040518082815260200191505060405180910390f35b341561011557fe5b61011d61083a565b6040518082600281111561012d57fe5b60ff16815260200191505060405180910390f35b341561014957fe5b610151610852565b60405180806020018281038252838181518152602001915080519060200190808383600083146101a0575b8051825260208311156101a05760208201915060208101905060208303925061017c565b505050905090810190601f1680156101cc5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156101e257fe5b6101ea6108f0565b6040518080602001828103825283818151815260200191508051906020019080838360008314610239575b80518252602083111561023957602082019150602081019050602083039250610215565b505050905090810190601f1680156102655780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561027b57fe5b610283610c0d565b6040518082815260200191505060405180910390f35b34156102a157fe5b6102a9610c13565b60405180806020018281038252838181518152602001915080519060200190808383600083146102f8575b8051825260208311156102f8576020820191506020810190506020830392506102d4565b505050905090810190601f1680156103245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561033a57fe5b610342610cb1565b6040518082815260200191505060405180910390f35b341561036057fe5b610368610cb7565b60405180806020018281038252838181518152602001915080519060200190808383600083146103b7575b8051825260208311156103b757602082019150602081019050602083039250610393565b505050905090810190601f1680156103e35780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156103f957fe5b61040f6004808035906020019091905050610d55565b604051808060200182810382528381815181526020019150805190602001908083836000831461045e575b80518252602083111561045e5760208201915060208101905060208303925061043a565b505050905090810190601f16801561048a5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156104a057fe5b6104a8610e14565b60405180806020018281038252838181518152602001915080519060200190808383600083146104f7575b8051825260208311156104f7576020820191506020810190506020830392506104d3565b505050905090810190601f1680156105235780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561053957fe5b610541610eb2565b6040518082600281111561055157fe5b60ff16815260200191505060405180910390f35b341561056d57fe5b6105c9600480803560ff1690602001909190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610ec5565b6040518080602001828103825283818151815260200191508051906020019080838360008314610618575b805182526020831115610618576020820191506020810190506020830392506105f4565b505050905090810190601f1680156106445780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561065a57fe5b6106ed600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610f77565b005b34156106f757fe5b6106ff610fda565b604051808060200182810382528381815181526020019150805190602001908083836000831461074e575b80518252602083111561074e5760208201915060208101905060208303925061072a565b505050905090810190601f16801561077a5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000818361082f60018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108255780601f106107fa57610100808354040283529160200191610825565b820191906000526020600020905b81548152906001019060200180831161080857829003601f168201915b5050505050611078565b020190505b92915050565b6000600860009054906101000a900460ff1690505b90565b60028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108e85780601f106108bd576101008083540402835291602001916108e8565b820191906000526020600020905b8154815290600101906020018083116108cb57829003601f168201915b505050505081565b6108f861158f565b610c0760008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109915780601f1061096657610100808354040283529160200191610991565b820191906000526020600020905b81548152906001019060200180831161097457829003601f168201915b505050505060018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a2c5780601f10610a0157610100808354040283529160200191610a2c565b820191906000526020600020905b815481529060010190602001808311610a0f57829003601f168201915b505050505060028054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ac75780601f10610a9c57610100808354040283529160200191610ac7565b820191906000526020600020905b815481529060010190602001808311610aaa57829003601f168201915b505050505060038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b625780601f10610b3757610100808354040283529160200191610b62565b820191906000526020600020905b815481529060010190602001808311610b4557829003601f168201915b505050505060048054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bfd5780601f10610bd257610100808354040283529160200191610bfd565b820191906000526020600020905b815481529060010190602001808311610be057829003601f168201915b5050505050611153565b90505b90565b60055481565b60038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ca95780601f10610c7e57610100808354040283529160200191610ca9565b820191906000526020600020905b815481529060010190602001808311610c8c57829003601f168201915b505050505081565b60065481565b60048054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d4d5780601f10610d2257610100808354040283529160200191610d4d565b820191906000526020600020905b815481529060010190602001808311610d3057829003601f168201915b505050505081565b610d5d61158f565b600760008381526020019081526020016000206001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e075780601f10610ddc57610100808354040283529160200191610e07565b820191906000526020600020905b815481529060010190602001808311610dea57829003601f168201915b505050505090505b919050565b60018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610eaa5780601f10610e7f57610100808354040283529160200191610eaa565b820191906000526020600020905b815481529060010190602001808311610e8d57829003601f168201915b505050505081565b600860009054906101000a900460ff1681565b610ecd61158f565b60018360ff161415610f3b576001600860006101000a81548160ff02191690836002811115610ef857fe5b0217905550604060405190810160405280600181526020017f20000000000000000000000000000000000000000000000000000000000000008152509050610f70565b60028360ff161415610f6f576002600860006101000a81548160ff02191690836002811115610f6657fe5b02179055508190505b5b5b92915050565b6000600760006005548152602001908152602001600020905082816000019080519060200190610fa89291906115a3565b5081816001019080519060200190610fc19291906115a3565b506005600081548092919060010191905055505b505050565b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110705780601f1061104557610100808354040283529160200191611070565b820191906000526020600020905b81548152906001019060200180831161105357829003601f168201915b505050505081565b6000611082611623565b6000600084925060009350600091505b825182101561114a5782828151811015156110a957fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027f0100000000000000000000000000000000000000000000000000000000000000900490506030811015801561112b575060398111155b1561113c5760308103600a85020193505b5b8180600101925050611092565b5b505050919050565b61115b61158f565b611163611623565b61116b611623565b611173611623565b61117b611623565b611183611623565b61118b61158f565b611193611623565b600060008e98508d97508c96508b95508a94508451865188518a518c51010101016040518059106111c15750595b908082528060200260200182016040525b50935083925060009150600090505b88518110156112955788818151811015156111f857fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002838380600101945081518110151561125757fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b80806001019150506111e1565b600090505b875181101561134e5787818151811015156112b157fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002838380600101945081518110151561131057fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505061129a565b600090505b865181101561140757868181518110151561136a57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015156113c957fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b8080600101915050611353565b600090505b85518110156114c057858181518110151561142357fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002838380600101945081518110151561148257fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505061140c565b600090505b84518110156115795784818151811015156114dc57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002838380600101945081518110151561153b57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b80806001019150506114c5565b8299505b50505050505050505095945050505050565b602060405190810160405280600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106115e457805160ff1916838001178555611612565b82800160010185558215611612579182015b828111156116115782518255916020019190600101906115f6565b5b50905061161f9190611637565b5090565b602060405190810160405280600081525090565b61165991905b8082111561165557600081600090555060010161163d565b5090565b905600a165627a7a72305820950b904252eb86c9a9e6b5610ec48a3d44b8a73e2ac41da9da072aa0c95b73ed0029', 
            gas: '4700000'
        },
        function(e, contract) {
            console.log(e, contract);
            //Store instance address
            addressContract = contract.address;
            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                res.end("Contract Posting created at the address:\n" + contract.address);
            }
        })

})


//Permet d'obtenir les informations de l'ordre passé
.get('/informations', function(req, res) {
    //Get _isopen value
    var Ref = contractInstance._aRef();
    var Quant = contractInstance._aQuantite();
    var Mont = contractInstance._aMontant();
    var nbOffre = contractInstance._numOffre();
    //var calcul = calcul();
    //res.end(calcul + "\n");
    //display it
    res.end("Pour l'ordre de référence " + Ref+ ".\nLe client a commandé " + Quant + " titres pour une valeur de "+ Mont + " par titre.\nIl y a pour l'instant " + nbOffre + " offre(s).");
    var cal = calcul();
    var result = contractInstance.result()
    console.log(result);
    var getData = contractInstance.calcul.getData(cal, 25);
    sendEther(getData);
    console.log(result);
})



//Permet d'entrer une offre
.get('/Offre/:Quant/:Montant', function(req, res, next){
    var Quant = req.params.Quant;
    var Montant = req.params.Montant;
    //appel de la fonction
    var getData = contractInstance.addOffre.getData(Quant, Montant);
    //transfert d'ether au contrat
     sendEther(getData);
})


.get('/State/get/', function(req, res) {
    //Get _isopen value
    var state = contractInstance._state();
    console.log(state);
    console.log(state.String);
    console.log(state.c[0]);
    switch(state.c[0]) {
    case 1:
        res.end("BBACC : Le contrat a été validé par le tiers");// A compéter avec les JSON
        break;
    case 2:
        res.end("BBREF : Le contrat a été refusé par le tiers");// A compéter avec les JSON
        break;
    default:
        res.end("BBAO : Le contrat n'a pas été validé");
    }

})

.get('/State/set/:newState', function(req, res) {

    var newState = req.params.newState;
    
    var tab = newState.split(" ");
    switch(tab[0]) {
    case "BBREF":
        var getData = contractInstance.setState.getData(2, tab[1]);
        sendEther(getData);
        console.log(contractInstance._state());

        console.log("\n"+getData);
        res.end("Enregistrement du refus");
       
        break;
    case "BBACC":
        var getData = contractInstance.setState.getData(1, "");
        sendEther(getData);
        res.end("Enregistrement de l'acceptation");// A compéter avec les JSON

        console.log(contractInstance._state());
        break;
    default:
        res.end("Le contrat n'a pas été validé");
    }

})


.get('/resumOffre/', function(req, res){

    var getData = contractInstance.getOffre.getData(0);
    //sendEther(getData);

    console.log(getData);

})



.use(function(req, res, next){
    res.setHeader('Content-Type', 'text/plain');
    res.send(404, 'Page introuvable !');
});


function calcul(){
     var code = BaseValeur[0].codeBareme; code = code.toLowerCase(); 


    //if(code.valueOf() == Bareme.valueOf()) console.log("true");
    for(var i=0; i<2; i++){   //attention le 2 est codé en dur
        var Bareme = BaseBareme[i].Bareme;Bareme = Bareme.toLowerCase();
        if(code.valueOf() == Bareme.valueOf()){
            MontantBrut = BaseBareme[i].MontantBrut;
            return MontantBrut;
        } 
    }

}

function sendEther(getData){
    web3.eth.sendTransaction({
        from: web3.eth.coinbase,
        to: addressContract,
        data: getData
    });
}


var server = app.listen(8081, function() {

    var host = server.address().address
    var port = server.address().port

    console.log("SmartContract DApp listening at http://%s:%s", host, port)

})

//app.use('/', express.static('./routes/contract.html'));